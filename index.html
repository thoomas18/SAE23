<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Instant Weather</title>
  <link rel="stylesheet" href="style.css">
  <!-- Ajoute Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
  <button id="darkmode-toggle" aria-label="Activer/D√©sactiver le mode sombre" style="position: absolute; top: 18px; right: 18px; z-index: 1000; background: #222; color: #fff; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.3em; cursor: pointer;">
    üåô
  </button>
  <div class="container">
    <h1>Instant Weather</h1>

    <div id="search-section">
      <label for="zipcode">Code Postal :</label>
      <input type="text" id="zipcode" placeholder="Entrez un code postal" aria-label="Code Postal" autocomplete="postal-code">

      <label for="commune">Commune :</label>
      <select id="commune" aria-label="S√©lectionnez une commune">
        <option value="">S√©lectionnez une commune</option>
      </select>

      <button onclick="getCommunes()" aria-label="Rechercher les communes">Rechercher</button>
      <button id="voir-meteo-btn" style="display:none;" onclick="showWeatherPage()" aria-label="Voir la m√©t√©o">Voir la m√©t√©o</button>
    </div>

    <div id="weather-page" style="display:none;">
      <h2>M√©t√©o pour <span id="city-name"></span></h2>
      <label for="days">Nombre de jours de pr√©vision :</label>
      <select id="days" onchange="displayWeather()" aria-label="Nombre de jours de pr√©vision">
        <option value="1">1 jour</option>
        <option value="2">2 jours</option>
        <option value="3">3 jours</option>
        <option value="4">4 jours</option>
        <option value="5">5 jours</option>
        <option value="6">6 jours</option>
        <option value="7">7 jours</option>
      </select>
      <div id="extra-infos" style="font-size: 0.9em; margin: 10px 0; display: flex; flex-wrap: wrap; gap: 10px;">
        <label><input type="checkbox" id="lat" onchange="displayWeather()" aria-label="Afficher la latitude"> Latitude</label>
        <label><input type="checkbox" id="lon" onchange="displayWeather()" aria-label="Afficher la longitude"> Longitude</label>
        <label><input type="checkbox" id="rain" onchange="displayWeather()" aria-label="Afficher le cumul de pluie"> Cumul de pluie</label>
        <label><input type="checkbox" id="wind" onchange="displayWeather()" aria-label="Afficher le vent moyen"> Vent moyen</label>
        <label><input type="checkbox" id="dir" onchange="displayWeather()" aria-label="Afficher la direction du vent"> Direction du vent</label>
      </div>
      <ul id="weather-info" tabindex="0" aria-live="polite"></ul>
      <div id="map" style="height: 250px; margin-top: 18px; border-radius: 8px;"></div>
      <button onclick="resetSearch()" aria-label="Nouvelle recherche">Nouvelle recherche</button>
    </div>
  </div>
  <!-- Ajoute Leaflet JS juste avant la fin du body -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let selectedCommune = null;

    async function getCommunes() {
      const codePostal = document.getElementById('zipcode').value;
      const communeSelect = document.getElementById('commune');
      communeSelect.innerHTML = '<option value="">Chargement...</option>';
      document.getElementById('voir-meteo-btn').style.display = 'none';

      // V√©rification basique du code postal (5 chiffres)
      if (!/^\d{5}$/.test(codePostal)) {
        communeSelect.innerHTML = '<option>Code postal invalide</option>';
        return;
      }

      try {
        const response = await fetch(`https://geo.api.gouv.fr/communes?codePostal=${codePostal}&fields=nom,centre&format=json`);
        if (!response.ok) {
          communeSelect.innerHTML = '<option>Erreur r√©seau ou API</option>';
          return;
        }
        const data = await response.json();

        communeSelect.innerHTML = '<option value="">S√©lectionnez une commune</option>';
        if (data.length > 0) {
          data.forEach(commune => {
            const option = document.createElement('option');
            option.value = JSON.stringify(commune);
            option.textContent = commune.nom;
            communeSelect.appendChild(option);
          });
        } else {
          communeSelect.innerHTML = '<option>Aucune commune trouv√©e</option>';
        }
      } catch (error) {
        communeSelect.innerHTML = '<option>Erreur de chargement (r√©seau ?)</option>';
        console.error(error);
      }
    }

    document.getElementById('commune').addEventListener('change', () => {
      const communeSelect = document.getElementById('commune');
      if (!communeSelect.value) {
        document.getElementById('voir-meteo-btn').style.display = 'none';
        return;
      }
      selectedCommune = JSON.parse(communeSelect.value);
      document.getElementById('voir-meteo-btn').style.display = 'inline-block';
    });

    // --- Ajout Leaflet ---
    let map = null;
    let marker = null;
    let windLayer = null;

    function showMap(lat, lon) {
      if (!map) {
        map = L.map('map').setView([lat, lon], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        marker = L.marker([lat, lon]).addTo(map);
      } else {
        map.setView([lat, lon], 12);
        marker.setLatLng([lat, lon]);
      }
      // Supprime la fl√®che si elle existe
      if (windLayer) {
        map.removeLayer(windLayer);
        windLayer = null;
      }
    }

    function showWindDirectionOnMap(lat, lon, dir) {
      // Supprime la fl√®che pr√©c√©dente si elle existe
      if (windLayer) {
        map.removeLayer(windLayer);
        windLayer = null;
      }
      // Ajoute une fl√®che orient√©e selon la direction du vent
      const arrowIcon = L.divIcon({
        className: 'wind-arrow',
        html: `<div style="transform: rotate(${dir}deg);">ü°∫</div>`,
        iconSize: [30, 30],
        iconAnchor: [15, 15]
      });
      windLayer = L.marker([lat, lon], { icon: arrowIcon }).addTo(map);
    }

    // Modifie showWeatherPage pour afficher la carte √† la s√©lection
    function showWeatherPage() {
      if (!selectedCommune) return;
      document.getElementById('search-section').style.display = 'none';
      document.getElementById('weather-page').style.display = 'block';
      document.getElementById('city-name').textContent = selectedCommune.nom;
      displayWeather();
      // Affiche la carte √† la position de la commune
      const [lon, lat] = selectedCommune.centre.coordinates;
      showMap(lat, lon);
    }

    // Affichage m√©t√©o 
    async function displayWeather() {
      if (!selectedCommune) return;
      const nbJours = document.getElementById('days').value;
      const infoList = document.getElementById('weather-info');
      infoList.innerHTML = '';

      // Ton token personnel ici
      const token = '5e392593461f451cde50dd846396cfa2dd9a7e63a369eb0615ee50cc4690d8e7';

      // Coordonn√©es de la commune
      const lat = selectedCommune.centre.coordinates[1];
      const lon = selectedCommune.centre.coordinates[0];

      try {
        // Appel √† l'API M√©t√©o Concept pour les pr√©visions quotidiennes
        const url = `https://api.meteo-concept.com/api/forecast/daily?token=${token}&latlng=${lat},${lon}&insee=&world=false`;
        const response = await fetch(url);
        if (!response.ok) throw new Error('Erreur API m√©t√©o');
        const data = await response.json();

        // Emojis m√©t√©o selon le code m√©t√©o de l'API
        const meteoEmojis = {
          0: "‚òÄÔ∏è", 1: "üå§Ô∏è", 2: "‚õÖ", 3: "üå•Ô∏è", 4: "‚òÅÔ∏è", 5: "üå¶Ô∏è", 6: "üåßÔ∏è", 7: "üåßÔ∏è", 10: "üå©Ô∏è", 11: "üå©Ô∏è", 12: "üåßÔ∏è", 13: "‚ùÑÔ∏è", 14: "üå®Ô∏è", 15: "üå´Ô∏è"
        };

        for (let i = 0; i < nbJours && i < data.forecast.length; i++) {
          const day = data.forecast[i];
          // Si le code m√©t√©o n'est pas connu, on met par d√©faut ‚òÅÔ∏è (nuage)
          const emoji = meteoEmojis.hasOwnProperty(day.weather) ? meteoEmojis[day.weather] : "‚òÅÔ∏è";
          const li = document.createElement('li');
          li.innerHTML = `${emoji} <strong>Jour ${i + 1}</strong> : Temp. min : ${day.tmin}¬∞C | Temp. max : ${day.tmax}¬∞C<br>
          üåßÔ∏è Probabilit√© de pluie : ${day.probarain ?? '-'}%<br>
          ‚òÄÔ∏è Temps d'ensoleillement : ${day.sun_hours ?? '-'} h`;
          infoList.appendChild(li);
        }

        // Infos suppl√©mentaires
        if (document.getElementById('lat').checked) {
          const li = document.createElement('li');
          li.textContent = `üß≠ Latitude : ${lat}`;
          infoList.appendChild(li);
        }
        if (document.getElementById('lon').checked) {
          const li = document.createElement('li');
          li.textContent = `üß≠ Longitude : ${lon}`;
          infoList.appendChild(li);
        }
        if (document.getElementById('rain').checked) {
          const li = document.createElement('li');
          li.textContent = `üåßÔ∏è Cumul de pluie : ${data.forecast[0].rr10 ?? '-'} mm`;
          infoList.appendChild(li);
        }
        if (document.getElementById('wind').checked) {
          const li = document.createElement('li');
          li.textContent = `üí® Vent moyen : ${data.forecast[0].wind10m ?? '-'} km/h`;
          infoList.appendChild(li);
        }
        if (document.getElementById('dir').checked) {
          const dir = data.forecast[0].dirwind10m ?? 0;
          showWindDirectionOnMap(lat, lon, dir);
        } else {
          showMap(lat, lon);
        }
      } catch (error) {
        const li = document.createElement('li');
        li.style.color = 'red';
        li.textContent = "Erreur lors de la r√©cup√©ration des donn√©es m√©t√©o.";
        infoList.appendChild(li);
        console.error(error);
      }
    }

    function resetSearch() {
      document.getElementById('zipcode').value = '';
      document.getElementById('commune').innerHTML = '<option value="">S√©lectionnez une commune</option>';
      document.getElementById('search-section').style.display = 'block';
      document.getElementById('weather-page').style.display = 'none';
      document.getElementById('voir-meteo-btn').style.display = 'none';
      selectedCommune = null;
    }
    // Gestion du mode sombre
    const darkBtn = document.getElementById('darkmode-toggle');
    function setDarkMode(on) {
      if (on) {
        document.body.classList.add('darkmode');
        localStorage.setItem('darkmode', 'on');
        darkBtn.textContent = '‚òÄÔ∏è';
      } else {
        document.body.classList.remove('darkmode');
        localStorage.setItem('darkmode', 'off');
        darkBtn.textContent = 'üåô';
      }
    }
    if (localStorage.getItem('darkmode') === 'on' ||
        (localStorage.getItem('darkmode') === null && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      setDarkMode(true);
    } else {
      setDarkMode(false);
    }
    darkBtn.onclick = () => setDarkMode(!document.body.classList.contains('darkmode'));
  </script>
</body>
</html>